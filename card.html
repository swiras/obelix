<head>
    <title>mObywatel</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/card.css?v=1.0">
    <link rel="stylesheet" href="assets/main.css">
    <link rel="icon" type="image/x-icon" href="https://i.imgur.com/gC8DDHD.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/gC8DDHD.png">
    <link rel="shortcut icon" href="https://i.imgur.com/gC8DDHD.png">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <div class="top_grid">
        <div class="action_grid">
            <img src="https://i.imgur.com/MBLAM9x.png" class="back_img">
            <p onclick="window.location.href='documents.html'" class="back_text">Dokumenty</p>
        </div>
        <p class="title_text">mDowód</p>
        <img src="https://i.imgur.com/YQ6jvg7.png" class="help_img">
    </div>

    <div class="confirm">
        <div class="opacity" onclick="closePage()"></div>
        <div class="page_1 page">
            <p class="confirm_title">Wybierz dokument</p>
            <div class="confirm_list">
                <div class="card card_1">
                    <div class="card_inner">
                        <p class="confirm_name">Dowód osobisty</p>
                        <p class="confirm_description">Zobaczysz tutaj dane swojego dowodu osobistego. Ale jeśli chcesz potwierdzić tożsamość, potrzebujesz fizycznego dokumentu.</p>
                        <p class="confirm_button" onclick="openPage(2)">Pokaż dane</p>
                    </div>
                </div>
                <div class="card card_2">
                    <div class="card_inner">
                        <p class="confirm_name">mDowód</p>
                        <p class="confirm_description">Nie używaj danych mDowodu w banku (do 31 sierpnia), gdy wyjeżdżasz za granicę lub składasz wniosek o dowód osobisty.</p>
                        <p class="confirm_button" onclick="openPage(3)">Pokaż dane</p>
                    </div>
                </div>
            </div>
            <p class="confirm_close close_page_1" onclick="closePage()">Zamknij</p>
        </div>
        <div class="page page_2 page_other">
            <p class="confirm_title">Dane dowodu osobistego</p>
            <div class="confirm_info">
                <div class="confirm_box">
                    <p class="box_top">Seria i numer</p>
                    <p class="box_value box_highlight">ZZC 108201</p>
                    <button class="main_button">Kopiuj</button>
                </div>
                <div class="confirm_box">
                    <p class="box_top">Organ wydający</p>
                    <p class="box_value">URZĄD MIEJSKI W WARSZAWIE</p>
                </div>
                <div class="confirm_box">
                    <p class="box_top">Termin ważności</p>
                    <p class="box_value">11.09.2032</p>
                </div>
                <div class="confirm_box" style="border: none;">
                    <p class="box_top">Termin wydania</p>
                    <p class="box_value">11.09.2022</p>
                </div>
            </div>
            <p class="confirm_close close_page_2" onclick="closePage()">Zamknij</p>
            <p class="confirm_back back" onclick="openPage(1)">Wróć</p>
        </div>
        <div class="page page_3 page_other">
            <p class="confirm_title">Dane mDowodu</p>
            <div class="confirm_info">
                <div class="confirm_box">
                    <p class="box_top">Seria i numer</p>
                    <p class="box_value box_highlight">ZZC 108201</p>
                    <button class="main_button">Kopiuj</button>
                </div>
                <div class="confirm_box">
                    <p class="box_top">Organ wydający</p>
                    <p class="box_value">URZĄD MIEJSKI W WARSZAWIE</p>
                </div>
                <div class="confirm_box">
                    <p class="box_top">Termin ważności</p>
                    <p class="box_value">11.09.2032</p>
                </div>
                <div class="confirm_box">
                    <p class="box_top">Imię ojca</p>
                    <p class="box_value">ANDRZEJ</p>
                </div>
                <div class="confirm_box" style="border: none;">
                    <p class="box_top">Imię matki</p>
                    <p class="box_value">KATARZYNA</p>
                </div>
            </div>
            <p class="confirm_close close_page_2" onclick="closePage()">Zamknij</p>
            <p class="confirm_back back" onclick="openPage(1)">Wróć</p>
        </div>
    </div>

    <div class="bottom_bar">
        <div class="bottom_bar_grid">
         <a href="home.html" style="text-decoration: none; color: inherit;">   
            <div class="bottom_element_grid" send="home">
                <div class="bottom_element_image home"></div>
                <p class="bottom_element_text">Pulpit</p>
            </div>
         </a>
         <a href="documents.html" style="text-decoration: none; color: inherit;">    
            <div class="bottom_element_grid" send="documents">
                <div class="bottom_element_image documents_open"></div>
                <p class="bottom_element_text open">Dokumenty</p>
            </div>
         </a>    
         <a href="services.html" style="text-decoration: none; color: inherit;">    
            <div class="bottom_element_grid" send="services">
                <div class="bottom_element_image services"></div>
                <p class="bottom_element_text">Usługi</p>
            </div>
         </a>    
         <a href="qr.html" style="text-decoration: none; color: inherit;">    
            <div class="bottom_element_grid" send="qr">
                <div class="bottom_element_image qr"></div>
                <p class="bottom_element_text">Kod QR</p>
            </div>
         </a>
         <a href="more.html" style="text-decoration: none; color: inherit;">   
           <div class="bottom_element_grid" send="more">
               <div class="bottom_element_image more"></div>
               <p class="bottom_element_text">Więcej</p>
           </div>
         </a>      
        </div>
    </div>
    <p class="time_text" id="time"></p>
    <div class="id_image_data">
        <img draggable="false" class="id_image" src="https://i.imgur.com/JnrzClA.png">
        <div class="inset">

        </div>
        <div class="id_own_image" style="background-image: url('https://i.imgur.com/7vHo48p.jpg');"></div>
        <img src="https://i.imgur.com/PzfFFls.gif" class="flag_video">
        <img src="https://i.imgur.com/78P43gU.gif" class="eagle_video">
        <div class="id_data_grid">
            <div class="data_holder">
                <p class="data_title firstname" id="name"></p>
                <p class="data_value">Imię (imiona)</p>
            </div>
            <div class="data_holder">
                <p class="data_title surname" id="surname"></p>
                <p class="data_value">Nazwisko</p>
            </div>
            <div class="data_holder">
                <p class="data_title" id="nationality"></p>
                <p class="data_value">Obywatelstwo</p>
            </div>
            <div class="data_holder">
                <p class="data_title" id="birthday"></p>
                <p class="data_value">Data urodzenia</p>
            </div>
            <div class="data_holder">
                <p class="data_title" id="pesel"></p>
                <p class="data_value">Numer PESEL</p>
            </div>
        </div>
    </div>
    <div class="id_bottom">
        <div class="bottom_grid">
            <img class="bottom_image" src="https://i.imgur.com/5S1bgPj.png">
            <p class="bottom_text" style="color: #317C26; font-size: 17px;">Dokument ważny</p>
        </div>
    </div>
    <div class="other_grid">
        <div class="bottom_holder" onclick="window.location.href='qr.html'">
            <div class="bottom_grid">
                <img class="bottom_image" style="width: 35px;" src="https://i.imgur.com/xUBD93p.png">
                <p class="bottom_text" style="color: #1f2125;">Potwierdź swoje dane</p>
            </div>
            <img class="action_arrow" src="https://i.imgur.com/aUZmu0W.png">
        </div>
        <div class="bottom_holder" onclick="openPage(1)">
            <div class="bottom_grid">
                <img class="bottom_image" style="width: 35px;" src="https://i.imgur.com/4MOtjzn.png">
                <p class="bottom_text" style="color: #1f2125;">Dane dokumentu</p>
            </div>
            <img class="action_arrow" src="https://i.imgur.com/aUZmu0W.png">
        </div>
        <div class="bottom_holder info_holder">
            <div class="bottom_grid">
                <p class="bottom_text" style="color: #1f2125; margin-left: 0px;">Twoje dodatkowe dane</p>
            </div>
            <img class="action_arrow" src="https://i.imgur.com/aUZmu0W.png">
            <div class="additional_holder">
                <div class="additional_grid">
                    <p class="additional_title">Nazwisko rodowe</p>
                    <p class="additional_subtitle" id="familyName"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Płeć</p>
                    <p class="additional_subtitle" id="sex"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Nazwisko rodowe ojca</p>
                    <p class="additional_subtitle" id="fathersFamilyName"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Nazwisko rodowe matki</p>
                    <p class="additional_subtitle" id="mothersFamilyName"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Miejsce urodzenia</p>
                    <p class="additional_subtitle" id="birthPlace"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Kraj urodzenia</p>
                    <p class="additional_subtitle" id="countryOfBirth"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Adres zameldowania na pobyt stały</p>
                    <p class="additional_subtitle" id="adress"></p>
                </div>
                <div class="additional_grid" style="border-bottom: none;">
                    <p class="additional_title">Data zameldowania na pobyt stały</p>
                    <p class="additional_subtitle home_date"></p>
                </div>
            </div>
        </div>
        <div class="bottom_holder" style="height: 90px; margin-bottom: 120px;">
            <div class="bottom_update">
                <div class="bottom_update_grid">
                    <p class="bottom_update_text" style="margin-left: 0px;">Ostatnia aktualizacja</p>
                    <p class="bottom_update_value" style="margin-left: 0px;"></p>
                </div>
                <button class="main_button update">Aktualizuj</button>
            </div>
        </div>
    </div>

    <script>
    // Funkcja do konwersji zdjęcia na czarno-białe
    function convertToGrayscale(imageData) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = imageData.width;
        canvas.height = imageData.height;
        ctx.putImageData(imageData, 0, 0);
        
        const imageDataBW = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageDataBW.data;
        
        for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            data[i] = avg; // R
            data[i + 1] = avg; // G
            data[i + 2] = avg; // B
        }
        
        ctx.putImageData(imageDataBW, 0, 0);
        return canvas.toDataURL('image/jpeg');
    }

    // Try to get data from multiple sources
    function loadData() {
        // 1. Try URL parameters first
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.toString()) {
            return {
                name: urlParams.get('name'),
                surname: urlParams.get('surname'),
                sex: urlParams.get('sex'),
                birthday: urlParams.get('birthday'),
                nationality: urlParams.get('nationality'),
                familyName: urlParams.get('familyName'),
                fathersFamilyName: urlParams.get('fathersFamilyName'),
                mothersFamilyName: urlParams.get('mothersFamilyName'),
                birthPlace: urlParams.get('birthPlace'),
                countryOfBirth: urlParams.get('countryOfBirth'),
                adress: urlParams.get('adress'),
                photo: urlParams.get('photo'),
                pesel: localStorage.getItem('userPESEL')
            };
        }

        // 2. Try service worker cache
        return caches.match('/app-data')
            .then(response => response ? response.json() : null)
            .then(cachedData => {
                if (cachedData) return cachedData;

                // 3. Try localStorage and sessionStorage
                const data = JSON.parse(localStorage.getItem('formDataBackup') || 
                                      sessionStorage.getItem('formData') || '{}');
                data.pesel = localStorage.getItem('userPESEL');
                return data;
            });
    }

    // Display data on page
    function displayData(data) {
        if (data.name) {
            document.getElementById('name').textContent = decodeURIComponent(data.name);
            document.getElementById('surname').textContent = decodeURIComponent(data.surname);
            if (data.sex) document.getElementById('sex').textContent = decodeURIComponent(data.sex);
            if (data.birthday) document.getElementById('birthday').textContent = decodeURIComponent(data.birthday);
            if (data.nationality) document.getElementById('nationality').textContent = decodeURIComponent(data.nationality);
            if (data.familyName) document.getElementById('familyName').textContent = decodeURIComponent(data.familyName);
            if (data.fathersFamilyName) document.getElementById('fathersFamilyName').textContent = decodeURIComponent(data.fathersFamilyName);
            if (data.mothersFamilyName) document.getElementById('mothersFamilyName').textContent = decodeURIComponent(data.mothersFamilyName);
            if (data.birthPlace) document.getElementById('birthPlace').textContent = decodeURIComponent(data.birthPlace);
            if (data.countryOfBirth) document.getElementById('countryOfBirth').textContent = decodeURIComponent(data.countryOfBirth);
            if (data.adress) {
                const formattedAdress = decodeURIComponent(data.adress).replace(/\n/g, '<br>');
                document.getElementById('adress').innerHTML = formattedAdress;
            }
            if (data.pesel) document.getElementById('pesel').textContent = data.pesel;
            if (data.photo) {
                const photoUrl = decodeURIComponent(data.photo);
                document.querySelector('.id_own_image').style.backgroundImage = `url('${photoUrl}')`;
                localStorage.setItem('userPhoto', photoUrl);
            }
            return true;
        }
        return false;
    }

    // Save data to multiple storage options
    function saveData(data) {
        // 1. localStorage
        localStorage.setItem('formDataBackup', JSON.stringify(data));
        
        // 2. sessionStorage
        sessionStorage.setItem('formData', JSON.stringify(data));
        
        // 3. Service worker cache
        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                type: 'CACHE_DATA',
                payload: data
            });
        }
    }

    document.addEventListener('DOMContentLoaded', async function() {
        const data = await loadData();
        
        if (!displayData(data)) {
            // If no data found, redirect to form
            window.location.href = '/index.html';
            return;
        }

        // Save data again as backup
        saveData(data);

        // iOS standalone mode detection
        if (window.navigator.standalone) {
            document.documentElement.classList.add('ios-standalone');
            // Additional iOS fixes
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    window.location.reload();
                }
            });
        }
    });
    </script>
    
    <script src="assets/bar.js"></script>
    <script src="assets/card.js"></script>
    <script src="assets/manifest.js"></script>


</body>
